{{define "settings-content"}}
<div class="max-w-4xl mx-auto" x-data="{ tab: 'general' }">
    <h1 class="text-3xl font-bold mb-6">Settings</h1>

    <!-- Tab bar -->
    <div role="tablist" class="tabs tabs-bordered mb-6">
        <button role="tab" class="tab" :class="tab === 'general' && 'tab-active'" @click="tab = 'general'">General</button>
        <button role="tab" class="tab" :class="tab === 'selfhost' && 'tab-active'" @click="tab = 'selfhost'">
            Self-Hosting
            <span class="badge badge-sm badge-ghost ml-1">Coming Soon</span>
        </button>
    </div>

    <!-- General tab -->
    <div x-show="tab === 'general'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Family Members -->
        <a href="/settings/family" class="card bg-base-100 shadow-md hover:shadow-lg transition-shadow cursor-pointer">
            <div class="card-body">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Family Members
                </h2>
                <p class="text-base-content/60">Add, edit, and manage family members and PINs.</p>
            </div>
        </a>

        <!-- Kiosk Mode -->
        <div class="card bg-base-100 shadow-md">
            <div class="card-body">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    Kiosk Mode
                </h2>
                <div id="kiosk-settings-container"
                     hx-get="/partials/settings/kiosk"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                    <span class="loading loading-spinner loading-sm"></span>
                </div>
            </div>
        </div>

        <!-- Rewards Management -->
        <div class="card bg-base-100 shadow-md">
            <div class="card-body">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                    </svg>
                    Rewards
                </h2>
                <div id="reward-manage-container"
                     hx-get="/partials/settings/rewards"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                    <span class="loading loading-spinner loading-sm"></span>
                </div>
            </div>
        </div>

        <!-- Theme -->
        <div class="card bg-base-100 shadow-md">
            <div class="card-body">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                    </svg>
                    Theme
                </h2>
                <div id="theme-settings-container"
                     hx-get="/partials/settings/theme"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                    <span class="loading loading-spinner loading-sm"></span>
                </div>
            </div>
        </div>

        <!-- Weather Settings -->
        <div class="card bg-base-100 shadow-md">
            <div class="card-body">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                    </svg>
                    Weather
                </h2>
                <div id="weather-settings-container"
                     hx-get="/partials/settings/weather"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                    <span class="loading loading-spinner loading-sm"></span>
                </div>
            </div>
        </div>

        <!-- Subscription -->
        <div class="card bg-base-100 shadow-md">
            <div class="card-body">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                    </svg>
                    Subscription
                </h2>
                <div id="license-settings-container"
                     hx-get="/partials/settings/license"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                    <span class="loading loading-spinner loading-sm"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Self-Hosting tab -->
    <div x-show="tab === 'selfhost'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Remote Access -->
        <div class="card bg-base-100 shadow-md">
            <div class="card-body">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Remote Access
                </h2>
                <div id="tunnel-settings-container"
                     hx-get="/partials/settings/tunnel"
                     hx-trigger="intersect once"
                     hx-swap="innerHTML">
                    <span class="loading loading-spinner loading-sm"></span>
                </div>
            </div>
        </div>

        <!-- S3 Storage -->
        <div class="card bg-base-100 shadow-md">
            <div class="card-body">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                    </svg>
                    S3 Storage
                </h2>
                <div id="s3-settings-container"
                     hx-get="/partials/settings/s3"
                     hx-trigger="intersect once"
                     hx-swap="innerHTML">
                    <span class="loading loading-spinner loading-sm"></span>
                </div>
            </div>
        </div>

        <!-- Encrypted Backups -->
        <div class="card bg-base-100 shadow-md">
            <div class="card-body">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Encrypted Backups
                </h2>
                <div id="backup-settings-container"
                     hx-get="/partials/settings/backup"
                     hx-trigger="intersect once"
                     hx-swap="innerHTML">
                    <span class="loading loading-spinner loading-sm"></span>
                </div>
            </div>
        </div>

        <!-- Push Notifications -->
        <div class="card bg-base-100 shadow-md">
            <div class="card-body">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                    Push Notifications
                </h2>
                <div id="push-settings-container"
                     hx-get="/partials/settings/push"
                     hx-trigger="intersect once"
                     hx-swap="innerHTML">
                    <span class="loading loading-spinner loading-sm"></span>
                </div>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "kiosk-settings-form"}}
<form hx-put="/partials/settings/kiosk"
      hx-target="#kiosk-settings-container"
      hx-swap="innerHTML"
      class="space-y-4"
      x-data="{ idleTimeout: '{{index . "idle_timeout_minutes"}}', quietEnabled: {{if eq (index . "quiet_hours_enabled") "true"}}true{{else}}false{{end}} }">

    <!-- Idle Timeout -->
    <div class="form-control">
        <label class="label">
            <span class="label-text font-medium">Idle timeout</span>
            <span class="label-text-alt" x-text="idleTimeout + ' min'"></span>
        </label>
        <input type="range" name="idle_timeout_minutes"
               min="1" max="30" step="1"
               class="range range-primary range-sm"
               x-model="idleTimeout">
    </div>

    <!-- Quiet Hours -->
    <div class="form-control">
        <label class="label cursor-pointer">
            <span class="label-text font-medium">Quiet hours (night mode)</span>
            <input type="checkbox" class="toggle toggle-primary"
                   x-model="quietEnabled"
                   @change="$el.value = quietEnabled ? 'true' : 'false'">
            <input type="hidden" name="quiet_hours_enabled" :value="quietEnabled ? 'true' : 'false'">
        </label>
    </div>

    <div x-show="quietEnabled" class="flex gap-3 items-center">
        <div class="form-control flex-1">
            <label class="label"><span class="label-text text-sm">Start</span></label>
            <input type="time" name="quiet_hours_start"
                   value="{{index . "quiet_hours_start"}}"
                   class="input input-bordered input-sm w-full">
        </div>
        <div class="form-control flex-1">
            <label class="label"><span class="label-text text-sm">End</span></label>
            <input type="time" name="quiet_hours_end"
                   value="{{index . "quiet_hours_end"}}"
                   class="input input-bordered input-sm w-full">
        </div>
    </div>

    <!-- Burn-in Prevention -->
    <div class="form-control">
        <label class="label cursor-pointer">
            <span class="label-text font-medium">Burn-in prevention</span>
            <input type="hidden" name="burn_in_prevention" value="{{index . "burn_in_prevention"}}">
            <input type="checkbox" class="toggle toggle-primary"
                   {{if eq (index . "burn_in_prevention") "true"}}checked{{end}}
                   @change="$el.previousElementSibling.value = $el.checked ? 'true' : 'false'">
        </label>
        <p class="text-xs text-base-content/50 ml-1">Subtle pixel shift during idle to prevent screen burn-in.</p>
    </div>

    <button type="submit" class="btn btn-primary btn-sm w-full">Save</button>
</form>
{{end}}

{{define "theme-settings-form"}}
<form hx-put="/partials/settings/theme"
      hx-target="#theme-settings-container"
      hx-swap="innerHTML"
      class="space-y-4"
      x-data="{
          mode: '{{index . "theme_mode"}}',
          selected: '{{index . "theme_selected"}}',
          light: '{{index . "theme_light"}}',
          dark: '{{index . "theme_dark"}}',
          themes: ['garden', 'forest', 'cupcake', 'dracula', 'gamwich'],
          themeLabels: { garden: 'Garden', forest: 'Forest', cupcake: 'Cupcake', dracula: 'Dracula', gamwich: 'Gamwich' },
          applyPreview(t) {
              document.documentElement.setAttribute('data-theme', t);
              localStorage.setItem('gamwich_theme', t);
          }
      }">

    <!-- Theme Mode -->
    <div class="form-control">
        <label class="label">
            <span class="label-text font-medium">Theme mode</span>
        </label>
        <select name="theme_mode" class="select select-bordered select-sm w-full" x-model="mode">
            <option value="manual">Manual</option>
            <option value="system">Follow system</option>
            <option value="quiet-hours">Follow quiet hours</option>
        </select>
    </div>

    <!-- Manual theme picker -->
    <div x-show="mode === 'manual'" class="form-control">
        <label class="label">
            <span class="label-text font-medium">Theme</span>
        </label>
        <div class="flex flex-wrap gap-2">
            <template x-for="t in themes" :key="t">
                <label class="cursor-pointer">
                    <input type="radio" name="theme_selected" :value="t" class="hidden peer"
                           x-model="selected"
                           @change="applyPreview(t)">
                    <div :data-theme="t"
                         class="rounded-lg p-2 border-2 border-transparent peer-checked:border-primary transition-all w-20">
                        <div class="flex gap-0.5 mb-1">
                            <div class="rounded w-3 h-3 bg-primary"></div>
                            <div class="rounded w-3 h-3 bg-secondary"></div>
                            <div class="rounded w-3 h-3 bg-accent"></div>
                        </div>
                        <div class="bg-base-100 rounded px-1 py-0.5">
                            <div class="text-[10px] text-base-content text-center" x-text="themeLabels[t]"></div>
                        </div>
                    </div>
                </label>
            </template>
        </div>
    </div>

    <!-- Light/dark theme pair (system or quiet-hours mode) -->
    <div x-show="mode !== 'manual'" class="space-y-3">
        <div class="form-control">
            <label class="label">
                <span class="label-text font-medium">Light theme</span>
            </label>
            <select name="theme_light" class="select select-bordered select-sm w-full" x-model="light">
                <template x-for="t in themes" :key="t">
                    <option :value="t" x-text="themeLabels[t]"></option>
                </template>
            </select>
        </div>
        <div class="form-control">
            <label class="label">
                <span class="label-text font-medium">Dark theme</span>
            </label>
            <select name="theme_dark" class="select select-bordered select-sm w-full" x-model="dark">
                <template x-for="t in themes" :key="t">
                    <option :value="t" x-text="themeLabels[t]"></option>
                </template>
            </select>
        </div>
    </div>

    <button type="submit" class="btn btn-primary btn-sm w-full">Save</button>
</form>
{{end}}

{{define "license-settings-form"}}
<div class="space-y-3">
    {{if .IsFreeTier}}
    <div class="badge badge-ghost">Free</div>
    <p class="text-sm text-base-content/60">Enter a license key to unlock cloud features like tunnel access, backups, and push notifications.</p>
    {{else}}
    <div class="flex items-center gap-2">
        <div class="badge badge-primary">{{.Plan}}</div>
        {{if .Valid}}
        <div class="badge badge-success badge-outline">Active</div>
        {{else}}
        <div class="badge badge-warning badge-outline">{{.Warning}}</div>
        {{end}}
    </div>
    {{if .Features}}
    <div class="flex flex-wrap gap-1 mt-1">
        {{range .Features}}
        <span class="badge badge-sm badge-outline">{{.}}</span>
        {{end}}
    </div>
    {{end}}
    {{if .ExpiresAt}}
    <p class="text-xs text-base-content/50">Expires: {{.ExpiresAt}}</p>
    {{end}}
    {{if .Offline}}
    <p class="text-xs text-warning">Offline - using cached license data</p>
    {{end}}
    {{end}}

    <form hx-put="/partials/settings/license"
          hx-target="#license-settings-container"
          hx-swap="innerHTML"
          class="space-y-3 mt-2"
          x-data="{ editing: false }">
        <div x-show="!editing">
            <button type="button" class="btn btn-sm btn-ghost" @click="editing = true">
                {{if .IsFreeTier}}Enter license key{{else}}Change key{{end}}
            </button>
        </div>
        <div x-show="editing" class="space-y-2">
            <input type="text" name="license_key"
                   placeholder="GW-XXXX-XXXX-XXXX-XXXX"
                   class="input input-bordered input-sm w-full font-mono"
                   pattern="GW-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}">
            <div class="flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm flex-1">Save</button>
                <button type="button" class="btn btn-ghost btn-sm" @click="editing = false">Cancel</button>
            </div>
        </div>
    </form>

    {{if .IsFreeTier}}
    <a href="https://gamwich.app/pricing" target="_blank" rel="noopener" class="btn btn-outline btn-sm w-full mt-2">
        Upgrade to Cloud
    </a>
    {{end}}
</div>
{{end}}

{{define "tunnel-settings-form"}}
<div class="space-y-3">
    {{if not .HasTunnel}}
    <div class="badge badge-ghost">Cloud Feature</div>
    <p class="text-sm text-base-content/60">Remote access lets you reach your Gamwich from anywhere via a secure tunnel.</p>
    <a href="https://gamwich.app/pricing" target="_blank" rel="noopener" class="btn btn-outline btn-sm w-full mt-2">
        Upgrade to Cloud
    </a>
    {{else}}
    <!-- Status badge (polls every 10s) -->
    <div id="tunnel-status-badge"
         hx-get="/partials/settings/tunnel/status"
         hx-trigger="every 10s"
         hx-swap="innerHTML">
        {{template "tunnel-status-inner" .}}
    </div>

    <form hx-put="/partials/settings/tunnel"
          hx-target="#tunnel-settings-container"
          hx-swap="innerHTML"
          class="space-y-3"
          x-data="{ enabled: {{.TunnelEnabled}}, showToken: false }">

        <!-- Enable/Disable toggle -->
        <div class="form-control">
            <label class="label cursor-pointer">
                <span class="label-text font-medium">Enable tunnel</span>
                <input type="hidden" name="tunnel_enabled" :value="enabled ? 'true' : 'false'">
                <input type="checkbox" class="toggle toggle-primary"
                       x-model="enabled">
            </label>
        </div>

        <!-- Token input -->
        <div x-show="enabled" class="form-control">
            <label class="label">
                <span class="label-text font-medium">Tunnel token</span>
                <button type="button" class="btn btn-xs btn-ghost" @click="showToken = !showToken"
                        x-text="showToken ? 'Hide' : 'Show'"></button>
            </label>
            <input :type="showToken ? 'text' : 'password'" name="tunnel_token"
                   value="{{.TunnelToken}}"
                   placeholder="Cloudflare tunnel token"
                   class="input input-bordered input-sm w-full font-mono">
        </div>

        <button type="submit" class="btn btn-primary btn-sm w-full">Save</button>
    </form>
    {{end}}
</div>
{{end}}

{{define "tunnel-status-inner"}}
{{if eq .TunnelState "connected"}}
<div class="flex items-center gap-2 flex-wrap">
    <div class="badge badge-success">Connected</div>
    {{if .TunnelSub}}
    <a href="https://{{.TunnelSub}}" target="_blank" rel="noopener" class="text-xs link link-primary">{{.TunnelSub}}</a>
    {{end}}
</div>
{{else if eq .TunnelState "connecting"}}
<div class="flex items-center gap-2">
    <div class="badge badge-info">Connecting</div>
    <span class="loading loading-spinner loading-xs"></span>
</div>
{{else if eq .TunnelState "reconnecting"}}
<div class="flex items-center gap-2">
    <div class="badge badge-warning">Reconnecting</div>
    <span class="loading loading-spinner loading-xs"></span>
</div>
{{else if eq .TunnelState "error"}}
<div class="space-y-1">
    <div class="badge badge-error">Error</div>
    {{if .TunnelError}}
    <p class="text-xs text-error">{{.TunnelError}}</p>
    {{end}}
</div>
{{else if eq .TunnelState "stopped"}}
<div class="badge badge-ghost">Stopped</div>
{{else}}
<div class="badge badge-ghost">Disabled</div>
{{end}}
{{end}}

{{define "tunnel-status-badge"}}
{{template "tunnel-status-inner" .}}
{{end}}

{{define "weather-settings-form"}}
<form hx-put="/partials/settings/weather"
      hx-target="#weather-settings-container"
      hx-swap="innerHTML"
      class="space-y-4"
      x-data="{ units: '{{index . "weather_units"}}' }">

    <!-- Latitude -->
    <div class="form-control">
        <label class="label">
            <span class="label-text font-medium">Latitude</span>
        </label>
        <input type="text" name="weather_latitude"
               value="{{index . "weather_latitude"}}"
               placeholder="e.g. 47.6062"
               class="input input-bordered input-sm w-full"
               inputmode="decimal">
    </div>

    <!-- Longitude -->
    <div class="form-control">
        <label class="label">
            <span class="label-text font-medium">Longitude</span>
        </label>
        <input type="text" name="weather_longitude"
               value="{{index . "weather_longitude"}}"
               placeholder="e.g. -122.3321"
               class="input input-bordered input-sm w-full"
               inputmode="decimal">
    </div>

    <!-- Temperature Unit -->
    <div class="form-control">
        <label class="label">
            <span class="label-text font-medium">Temperature unit</span>
        </label>
        <div class="flex gap-2">
            <label class="label cursor-pointer gap-2">
                <input type="radio" name="weather_units" value="fahrenheit"
                       class="radio radio-primary radio-sm"
                       x-model="units">
                <span class="label-text">Fahrenheit</span>
            </label>
            <label class="label cursor-pointer gap-2">
                <input type="radio" name="weather_units" value="celsius"
                       class="radio radio-primary radio-sm"
                       x-model="units">
                <span class="label-text">Celsius</span>
            </label>
        </div>
    </div>

    <p class="text-xs text-base-content/50">Leave latitude and longitude empty to disable the weather widget.</p>

    <button type="submit" class="btn btn-primary btn-sm w-full">Save</button>
</form>
{{end}}

{{define "backup-settings-form"}}
<div class="space-y-3">
    {{if not .HasBackup}}
    <div class="badge badge-ghost">Cloud Feature</div>
    <p class="text-sm text-base-content/60">Encrypted offsite backups keep your family data safe with daily automated backups to secure cloud storage.</p>
    <a href="https://gamwich.app/pricing" target="_blank" rel="noopener" class="btn btn-outline btn-sm w-full mt-2">
        Upgrade to Cloud
    </a>
    {{else}}
    <!-- Status badge (polls every 15s) -->
    <div id="backup-status-badge"
         hx-get="/partials/settings/backup/status"
         hx-trigger="every 15s"
         hx-swap="innerHTML">
        {{template "backup-status-inner" .}}
    </div>

    {{if not .PassphraseSet}}
    <!-- Passphrase setup required first -->
    <div class="alert alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        <span class="text-sm">Set an encryption passphrase to enable backups. This passphrase encrypts your data before upload — keep it safe, it cannot be recovered.</span>
    </div>
    <form hx-put="/partials/settings/backup/passphrase"
          hx-target="#backup-settings-container"
          hx-swap="innerHTML"
          class="space-y-2">
        <div class="form-control">
            <input type="password" name="passphrase"
                   placeholder="Encryption passphrase (min 8 chars)"
                   class="input input-bordered input-sm w-full"
                   minlength="8" required>
        </div>
        <button type="submit" class="btn btn-primary btn-sm w-full">Set Passphrase</button>
    </form>
    {{else}}
    <!-- Schedule settings -->
    <form hx-put="/partials/settings/backup"
          hx-target="#backup-settings-container"
          hx-swap="innerHTML"
          class="space-y-3"
          x-data="{ enabled: {{.BackupEnabled}}, hour: '{{.ScheduleHour}}', retention: '{{.RetentionDays}}' }">

        <div class="form-control">
            <label class="label cursor-pointer">
                <span class="label-text font-medium">Enable scheduled backups</span>
                <input type="hidden" name="backup_enabled" :value="enabled ? 'true' : 'false'">
                <input type="checkbox" class="toggle toggle-primary" x-model="enabled">
            </label>
        </div>

        <div x-show="enabled" class="space-y-3">
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-medium">Backup hour (UTC)</span>
                </label>
                <select name="backup_schedule_hour" class="select select-bordered select-sm w-full" x-model="hour">
                    {{range $i := seq 0 23}}
                    <option value="{{$i}}">{{printf "%02d" $i}}:00 UTC</option>
                    {{end}}
                </select>
            </div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text font-medium">Retention period</span>
                </label>
                <select name="backup_retention_days" class="select select-bordered select-sm w-full" x-model="retention">
                    <option value="7">7 days</option>
                    <option value="14">14 days</option>
                    <option value="30">30 days</option>
                    <option value="90">90 days</option>
                </select>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-sm w-full">Save Schedule</button>
    </form>

    <!-- Backup Now -->
    <div class="divider text-xs">Manual Backup</div>
    <form hx-post="/partials/settings/backup/now"
          hx-swap="none"
          class="space-y-2"
          x-data="{ showPass: false }">
        <div class="form-control">
            <div class="join w-full">
                <input :type="showPass ? 'text' : 'password'" name="passphrase"
                       placeholder="Enter passphrase to confirm"
                       class="input input-bordered input-sm join-item flex-1" required>
                <button type="button" class="btn btn-ghost btn-sm join-item"
                        @click="showPass = !showPass"
                        x-text="showPass ? 'Hide' : 'Show'"></button>
            </div>
        </div>
        <button type="submit" class="btn btn-secondary btn-sm w-full">Backup Now</button>
    </form>

    <!-- Backup History -->
    <div class="divider text-xs">History</div>
    <div id="backup-history-container"
         hx-get="/partials/settings/backup/history"
         hx-trigger="load, every 30s"
         hx-swap="innerHTML">
        <span class="loading loading-spinner loading-xs"></span>
    </div>

    {{if .TotalSize}}
    <p class="text-xs text-base-content/50">Total backup storage: {{formatBytes .TotalSize}}</p>
    {{end}}

    <!-- Change Passphrase -->
    <div class="divider text-xs">Security</div>
    <details class="collapse collapse-arrow bg-base-200">
        <summary class="collapse-title text-sm font-medium p-2 min-h-0">Change passphrase</summary>
        <div class="collapse-content p-2">
            <form hx-put="/partials/settings/backup/passphrase"
                  hx-target="#backup-settings-container"
                  hx-swap="innerHTML"
                  class="space-y-2">
                <input type="password" name="passphrase"
                       placeholder="New passphrase (min 8 chars)"
                       class="input input-bordered input-sm w-full"
                       minlength="8" required>
                <p class="text-xs text-warning">Changing the passphrase will not re-encrypt existing backups. Old backups require the old passphrase to restore.</p>
                <button type="submit" class="btn btn-warning btn-sm w-full">Change Passphrase</button>
            </form>
        </div>
    </details>

    {{if not .HasCachedKey}}
    <div class="alert alert-warning alert-sm">
        <span class="text-xs">Scheduled backups require the passphrase to be entered once after restart. Use "Backup Now" to cache it.</span>
    </div>
    {{end}}
    {{end}}
    {{end}}
</div>
{{end}}

{{define "backup-status-inner"}}
{{if eq .BackupState "running"}}
<div class="flex items-center gap-2">
    <div class="badge badge-info">Backing up</div>
    <span class="loading loading-spinner loading-xs"></span>
</div>
{{else if eq .BackupState "error"}}
<div class="space-y-1">
    <div class="badge badge-error">Error</div>
    {{if .BackupError}}
    <p class="text-xs text-error">{{.BackupError}}</p>
    {{end}}
</div>
{{else if eq .BackupState "idle"}}
<div class="badge badge-success">Ready</div>
{{else}}
<div class="badge badge-ghost">Disabled</div>
{{end}}
{{end}}

{{define "backup-status-badge"}}
{{template "backup-status-inner" .}}
{{end}}

{{define "backup-history-list"}}
{{if .History}}
<div class="overflow-x-auto">
    <table class="table table-xs">
        <thead>
            <tr>
                <th>Date</th>
                <th>Size</th>
                <th>Status</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {{range .History}}
            <tr>
                <td class="text-xs">{{.CreatedAt.Format "Jan 2, 15:04"}}</td>
                <td class="text-xs">{{if eq .Status "completed"}}{{formatBytes .SizeBytes}}{{else}}-{{end}}</td>
                <td>
                    {{if eq (printf "%s" .Status) "completed"}}
                    <span class="badge badge-success badge-xs">OK</span>
                    {{else if eq (printf "%s" .Status) "failed"}}
                    <span class="badge badge-error badge-xs" title="{{.ErrorMessage}}">Failed</span>
                    {{else if eq (printf "%s" .Status) "uploading"}}
                    <span class="badge badge-info badge-xs">Uploading</span>
                    {{else}}
                    <span class="badge badge-ghost badge-xs">Pending</span>
                    {{end}}
                </td>
                <td class="text-right">
                    {{if eq (printf "%s" .Status) "completed"}}
                    <div class="flex gap-1 justify-end">
                        <a href="/partials/settings/backup/download/{{.ID}}"
                           class="btn btn-ghost btn-xs" title="Download">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </a>
                        <button class="btn btn-ghost btn-xs text-warning" title="Restore"
                                x-data
                                @click="if(confirm('Restore from this backup? The app will restart.')) {
                                    const pass = prompt('Enter passphrase to restore:');
                                    if(pass) {
                                        const form = new FormData();
                                        form.set('passphrase', pass);
                                        fetch('/partials/settings/backup/restore/{{.ID}}', {method:'POST', body:form});
                                    }
                                }">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                    </div>
                    {{end}}
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
</div>
{{else}}
<p class="text-sm text-base-content/50 text-center py-2">No backups yet</p>
{{end}}
{{end}}

{{define "push-settings-form"}}
<div class="space-y-3">
    {{if not .HasPush}}
    <div class="badge badge-ghost">Cloud Feature</div>
    <p class="text-sm text-base-content/60">Push notifications let family members receive reminders for calendar events, chore due dates, and grocery list updates.</p>
    <a href="https://gamwich.app/pricing" target="_blank" rel="noopener" class="btn btn-outline btn-sm w-full mt-2">
        Upgrade to Cloud
    </a>
    {{else}}
    <div x-data="pushSettings()" x-init="init()">
        <!-- Enable/Status section -->
        <div class="space-y-3">
            <template x-if="!supported">
                <div class="alert alert-warning">
                    <span class="text-sm">Push notifications are not supported in this browser.</span>
                </div>
            </template>

            <template x-if="supported && permission === 'denied'">
                <div class="alert alert-error">
                    <span class="text-sm">Notifications are blocked. Please enable them in your browser settings.</span>
                </div>
            </template>

            <template x-if="supported && permission !== 'denied'">
                <div>
                    <template x-if="!subscribed">
                        <button class="btn btn-primary btn-sm w-full" @click="enablePush()" :disabled="enabling">
                            <span x-show="!enabling">Enable Notifications</span>
                            <span x-show="enabling" class="loading loading-spinner loading-xs"></span>
                        </button>
                    </template>
                    <template x-if="subscribed">
                        <div class="flex items-center gap-2">
                            <div class="badge badge-success">Enabled</div>
                            <button class="btn btn-ghost btn-xs" @click="disablePush()">Disable</button>
                        </div>
                    </template>
                </div>
            </template>
        </div>

        <!-- Notification Preferences -->
        <template x-if="subscribed">
            <div class="space-y-3 mt-3">
                <div class="divider text-xs">Notification Types</div>
                <form hx-put="/partials/settings/push/preferences"
                      hx-target="#push-settings-container"
                      hx-swap="innerHTML"
                      class="space-y-2"
                      x-data="{ cal: {{.CalendarEnabled}}, chore: {{.ChoreEnabled}}, grocery: {{.GroceryEnabled}} }">

                    <div class="form-control">
                        <label class="label cursor-pointer">
                            <span class="label-text font-medium">Calendar reminders</span>
                            <input type="hidden" name="calendar_enabled" :value="cal ? 'true' : 'false'">
                            <input type="checkbox" class="toggle toggle-primary toggle-sm" x-model="cal">
                        </label>
                    </div>

                    <div class="form-control">
                        <label class="label cursor-pointer">
                            <span class="label-text font-medium">Chore due reminders</span>
                            <input type="hidden" name="chore_enabled" :value="chore ? 'true' : 'false'">
                            <input type="checkbox" class="toggle toggle-primary toggle-sm" x-model="chore">
                        </label>
                    </div>

                    <div class="form-control">
                        <label class="label cursor-pointer">
                            <span class="label-text font-medium">Grocery list additions</span>
                            <input type="hidden" name="grocery_enabled" :value="grocery ? 'true' : 'false'">
                            <input type="checkbox" class="toggle toggle-primary toggle-sm" x-model="grocery">
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary btn-sm w-full">Save Preferences</button>
                </form>

                <!-- Test Notification -->
                <div class="divider text-xs">Test</div>
                <button class="btn btn-secondary btn-sm w-full"
                        @click="sendTest()">
                    Send Test Notification
                </button>

                <!-- Registered Devices -->
                {{if .Subscriptions}}
                <div class="divider text-xs">Devices ({{.SubscriptionCount}})</div>
                {{template "push-devices-list" .}}
                {{end}}
            </div>
        </template>

        {{if .VAPIDKeysConfigured}}
        <details class="collapse collapse-arrow bg-base-200 mt-3">
            <summary class="collapse-title text-sm font-medium p-2 min-h-0">VAPID Keys</summary>
            <div class="collapse-content p-2 space-y-2" x-data="{ showKey: false }">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-xs font-medium">Public key</span>
                        <button type="button" class="btn btn-xs btn-ghost" @click="showKey = !showKey"
                                x-text="showKey ? 'Hide' : 'Show'"></button>
                    </label>
                    <template x-if="showKey">
                        <code class="text-xs break-all bg-base-300 rounded p-2">{{.VAPIDPublicKeyFull}}</code>
                    </template>
                    <template x-if="!showKey">
                        <code class="text-xs bg-base-300 rounded p-2">••••••••••••••••</code>
                    </template>
                </div>
                <p class="text-xs text-warning">Changing VAPID keys invalidates all existing push subscriptions.</p>
            </div>
        </details>
        {{end}}
    </div>

    <script>
    function pushSettings() {
        return {
            supported: ('serviceWorker' in navigator && 'PushManager' in window),
            permission: (typeof Notification !== 'undefined' ? Notification.permission : 'denied'),
            subscribed: {{if .Subscriptions}}{{if gt .SubscriptionCount 0}}true{{else}}false{{end}}{{else}}false{{end}},
            enabling: false,
            vapidKey: '{{.VAPIDKey}}',

            init() {
                if (this.supported && Notification.permission === 'granted') {
                    navigator.serviceWorker.ready.then(function(reg) {
                        return reg.pushManager.getSubscription();
                    }).then(function(sub) {
                        // subscription check complete
                    });
                }
            },

            async enablePush() {
                this.enabling = true;
                try {
                    var perm = await Notification.requestPermission();
                    this.permission = perm;
                    if (perm !== 'granted') {
                        this.enabling = false;
                        return;
                    }

                    var reg = await navigator.serviceWorker.ready;
                    var sub = await reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: this.urlBase64ToUint8Array(this.vapidKey)
                    });

                    var key = sub.getKey('p256dh');
                    var authKey = sub.getKey('auth');

                    var resp = await fetch('/api/push/subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            endpoint: sub.endpoint,
                            p256dh: btoa(String.fromCharCode.apply(null, new Uint8Array(key))),
                            auth: btoa(String.fromCharCode.apply(null, new Uint8Array(authKey))),
                            device_name: navigator.userAgent.split('(')[0].trim()
                        })
                    });

                    if (resp.ok) {
                        this.subscribed = true;
                        htmx.ajax('GET', '/partials/settings/push', '#push-settings-container');
                    }
                } catch (e) {
                    console.error('Push subscribe failed:', e);
                }
                this.enabling = false;
            },

            async disablePush() {
                try {
                    var reg = await navigator.serviceWorker.ready;
                    var sub = await reg.pushManager.getSubscription();
                    if (sub) {
                        await sub.unsubscribe();
                    }
                    this.subscribed = false;
                    htmx.ajax('GET', '/partials/settings/push', '#push-settings-container');
                } catch (e) {
                    console.error('Push unsubscribe failed:', e);
                }
            },

            async sendTest() {
                try {
                    await fetch('/api/push/test', { method: 'POST' });
                } catch (e) {
                    console.error('Test push failed:', e);
                }
            },

            urlBase64ToUint8Array(base64String) {
                var padding = '='.repeat((4 - base64String.length % 4) % 4);
                var base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                var rawData = window.atob(base64);
                var outputArray = new Uint8Array(rawData.length);
                for (var i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }
        };
    }
    </script>
    {{end}}
</div>
{{end}}

{{define "s3-settings-form"}}
<div class="space-y-3">
    {{if .Configured}}
    <div class="badge badge-success badge-sm">Configured</div>
    {{else}}
    <div class="badge badge-ghost badge-sm">Not configured</div>
    {{end}}
    <p class="text-xs text-base-content/50">S3-compatible storage for encrypted backups (e.g. Backblaze B2, Wasabi, AWS S3).</p>

    <form hx-put="/partials/settings/s3"
          hx-target="#s3-settings-container"
          hx-swap="innerHTML"
          class="space-y-3"
          x-data="{ showKeys: false }">

        <div class="form-control">
            <label class="label">
                <span class="label-text font-medium">Endpoint</span>
            </label>
            <input type="url" name="backup_s3_endpoint"
                   value="{{.Endpoint}}"
                   placeholder="https://s3.us-west-001.backblazeb2.com"
                   class="input input-bordered input-sm w-full">
        </div>

        <div class="form-control">
            <label class="label">
                <span class="label-text font-medium">Bucket</span>
            </label>
            <input type="text" name="backup_s3_bucket"
                   value="{{.Bucket}}"
                   placeholder="gamwich-backups"
                   class="input input-bordered input-sm w-full">
        </div>

        <div class="form-control">
            <label class="label">
                <span class="label-text font-medium">Region</span>
            </label>
            <input type="text" name="backup_s3_region"
                   value="{{.Region}}"
                   placeholder="us-west-001"
                   class="input input-bordered input-sm w-full">
        </div>

        <div class="form-control">
            <label class="label">
                <span class="label-text font-medium">Access key</span>
                <button type="button" class="btn btn-xs btn-ghost" @click="showKeys = !showKeys"
                        x-text="showKeys ? 'Hide' : 'Show'"></button>
            </label>
            <input :type="showKeys ? 'text' : 'password'" name="backup_s3_access_key"
                   value="{{.AccessKey}}"
                   placeholder="Access key ID"
                   class="input input-bordered input-sm w-full font-mono">
        </div>

        <div class="form-control">
            <label class="label">
                <span class="label-text font-medium">Secret key</span>
            </label>
            <input :type="showKeys ? 'text' : 'password'" name="backup_s3_secret_key"
                   value="{{.SecretKey}}"
                   placeholder="Secret access key"
                   class="input input-bordered input-sm w-full font-mono">
        </div>

        <button type="submit" class="btn btn-primary btn-sm w-full">Save</button>
    </form>
</div>
{{end}}

{{define "push-devices-list"}}
{{if .Subscriptions}}
<div class="space-y-1">
    {{range .Subscriptions}}
    <div class="flex items-center justify-between text-sm bg-base-200 rounded px-2 py-1">
        <span class="truncate flex-1">{{if .DeviceName}}{{.DeviceName}}{{else}}Unknown device{{end}}</span>
        <button class="btn btn-ghost btn-xs text-error"
                hx-delete="/partials/settings/push/devices/{{.ID}}"
                hx-target="#push-settings-container"
                hx-swap="innerHTML"
                hx-confirm="Remove this device?">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>
    {{end}}
</div>
{{end}}
{{end}}
