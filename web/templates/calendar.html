{{define "calendar-content"}}
<div class="max-w-5xl mx-auto" x-data="{ view: '{{.View}}' }">
    <!-- View Toggle Tabs -->
    <div class="flex items-center justify-between mb-4">
        <h1 class="text-3xl font-bold">Calendar</h1>
        <div class="tabs tabs-boxed tabs-lg">
            <button class="tab"
                    :class="view === 'day' ? 'tab-active' : ''"
                    hx-get="/partials/calendar/day?date={{.DateStr}}"
                    hx-target="#calendar-view-content"
                    @click="view = 'day'">Day</button>
            <button class="tab"
                    :class="view === 'week' ? 'tab-active' : ''"
                    hx-get="/partials/calendar/week?date={{.DateStr}}"
                    hx-target="#calendar-view-content"
                    @click="view = 'week'">Week</button>
        </div>
    </div>

    <!-- Calendar View Content -->
    <div id="calendar-view-content">
        {{if eq .View "week"}}
            {{.ViewContent}}
        {{else}}
            {{.ViewContent}}
        {{end}}
    </div>
</div>

<!-- Event Modal -->
<dialog id="event-modal" class="modal">
    <div id="event-modal-body" class="modal-box max-w-lg">
        <!-- Event form/detail loaded here via HTMX -->
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
{{end}}

{{define "calendar-day-view"}}
<div>
    <!-- Date Header with Navigation -->
    <div class="flex items-center justify-between mb-4">
        <button class="btn btn-ghost btn-lg"
                hx-get="/partials/calendar/day?date={{.PrevDate}}"
                hx-target="#calendar-view-content">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
        <div class="text-center">
            <div class="text-2xl font-bold">{{.DateLabel}}</div>
            {{if .IsToday}}<div class="badge badge-primary badge-sm mt-1">Today</div>{{end}}
        </div>
        <button class="btn btn-ghost btn-lg"
                hx-get="/partials/calendar/day?date={{.NextDate}}"
                hx-target="#calendar-view-content">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </button>
    </div>

    <!-- All-Day Events -->
    {{if .AllDayEvents}}
    <div class="mb-4 space-y-1">
        {{range .AllDayEvents}}
        <div class="rounded-lg px-3 py-2 text-sm font-medium text-white cursor-pointer"
             style="background-color: {{.Color}}"
             hx-get="/partials/calendar/events/{{.ID}}?recurring={{if .IsRecurring}}1{{else}}0{{end}}&parent_id={{.ParentID}}&occurrence_date={{.OccurrenceDate}}"
             hx-target="#event-modal-body"
             hx-swap="innerHTML"
             onclick="document.getElementById('event-modal').showModal()">
            {{if .IsRecurring}}<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 inline-block mr-1 -mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>{{end}}
            {{.Title}}
            {{if .MemberEmoji}}<span class="ml-1">{{.MemberEmoji}}</span>{{end}}
        </div>
        {{end}}
    </div>
    {{end}}

    <!-- Day Timeline Grid -->
    <div class="card bg-base-100 shadow-md overflow-hidden">
        <div class="relative" style="height: 1020px;"> <!-- 17 hours * 60px -->
            <!-- Hour Lines & Labels -->
            {{range .Hours}}
            <div class="absolute w-full border-t border-base-300 flex"
                 style="top: {{.TopPx}}px; height: 60px;">
                <div class="w-16 text-xs text-base-content/40 pr-2 text-right pt-0.5 flex-shrink-0">{{.Label}}</div>
                <div class="flex-1 relative cursor-pointer hover:bg-base-200/50 transition-colors"
                     hx-get="/partials/calendar/events/new?date={{$.DateStr}}&hour={{.Hour}}"
                     hx-target="#event-modal-body"
                     hx-swap="innerHTML"
                     onclick="document.getElementById('event-modal').showModal()">
                </div>
            </div>
            {{end}}

            <!-- Events -->
            {{range .TimedEvents}}
            <div class="absolute rounded-lg px-2 py-1 text-sm text-white overflow-hidden cursor-pointer hover:brightness-110 transition-all"
                 style="top: {{.TopPx}}px; height: {{.HeightPx}}px; left: 68px; right: 8px; background-color: {{.Color}}; min-height: 24px;"
                 hx-get="/partials/calendar/events/{{.ID}}?recurring={{if .IsRecurring}}1{{else}}0{{end}}&parent_id={{.ParentID}}&occurrence_date={{.OccurrenceDate}}"
                 hx-target="#event-modal-body"
                 hx-swap="innerHTML"
                 onclick="document.getElementById('event-modal').showModal()">
                <div class="font-medium truncate">
                    {{if .IsRecurring}}<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 inline-block mr-0.5 -mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>{{end}}
                    {{.Title}}
                </div>
                {{if ge .HeightPx 40}}
                <div class="text-xs opacity-80">{{.TimeRange}}</div>
                {{end}}
            </div>
            {{end}}
        </div>
    </div>

    <!-- Floating Add Button -->
    <div class="fixed bottom-24 right-6 z-10">
        <button class="btn btn-primary btn-circle btn-lg shadow-lg"
                hx-get="/partials/calendar/events/new?date={{.DateStr}}"
                hx-target="#event-modal-body"
                hx-swap="innerHTML"
                onclick="document.getElementById('event-modal').showModal()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
        </button>
    </div>
</div>
{{end}}

{{define "calendar-week-view"}}
<div>
    <!-- Week Header with Navigation -->
    <div class="flex items-center justify-between mb-4">
        <button class="btn btn-ghost btn-lg"
                hx-get="/partials/calendar/week?date={{.PrevWeek}}"
                hx-target="#calendar-view-content">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
        <div class="text-xl font-bold">{{.WeekLabel}}</div>
        <button class="btn btn-ghost btn-lg"
                hx-get="/partials/calendar/week?date={{.NextWeek}}"
                hx-target="#calendar-view-content">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </button>
    </div>

    <!-- Week Grid -->
    <div class="grid grid-cols-7 gap-2">
        {{range .Days}}
        <div class="card bg-base-100 shadow-sm cursor-pointer hover:shadow-md transition-shadow min-h-[140px] {{if .IsToday}}ring-2 ring-primary{{end}}"
             hx-get="/partials/calendar/day?date={{.DateStr}}"
             hx-target="#calendar-view-content">
            <div class="card-body p-3">
                <div class="text-xs text-base-content/50 uppercase">{{.DayName}}</div>
                <div class="text-lg font-bold {{if .IsToday}}text-primary{{end}}">{{.DayNum}}</div>
                <div class="space-y-1 mt-1">
                    {{range .Events}}
                    <div class="rounded px-1.5 py-0.5 text-xs text-white truncate"
                         style="background-color: {{.Color}}">
                        {{if .IsRecurring}}<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block -mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>{{end}}
                        {{.Title}}
                    </div>
                    {{end}}
                    {{if .MoreCount}}
                    <div class="text-xs text-base-content/40">+{{.MoreCount}} more</div>
                    {{end}}
                </div>
            </div>
        </div>
        {{end}}
    </div>

    <!-- Floating Add Button -->
    <div class="fixed bottom-24 right-6 z-10">
        <button class="btn btn-primary btn-circle btn-lg shadow-lg"
                hx-get="/partials/calendar/events/new?date={{.TodayStr}}"
                hx-target="#event-modal-body"
                hx-swap="innerHTML"
                onclick="document.getElementById('event-modal').showModal()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
        </button>
    </div>
</div>
{{end}}

{{define "event-form"}}
<div x-data="eventForm()">
    <h3 class="text-xl font-bold mb-4">New Event</h3>

    <form hx-post="/partials/calendar/events"
          hx-target="#calendar-view-content"
          @submit="prepareSubmit()">

        <!-- Title -->
        <div class="form-control mb-3">
            <label class="label"><span class="label-text font-medium">Title</span></label>
            <input type="text" name="title" x-model="title"
                   class="input input-bordered input-lg w-full"
                   placeholder="Event title" required autofocus>
        </div>

        <!-- All Day Toggle -->
        <div class="form-control mb-3">
            <label class="label cursor-pointer justify-start gap-3">
                <input type="checkbox" x-model="allDay" class="toggle toggle-primary toggle-lg">
                <span class="label-text font-medium">All day</span>
            </label>
        </div>

        <!-- Date Picker -->
        <div class="form-control mb-3">
            <label class="label"><span class="label-text font-medium">Date</span></label>
            <div class="flex items-center gap-2">
                <button type="button" class="btn btn-ghost btn-sm" @click="prevDay()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <div class="flex-1 text-center text-lg font-medium" x-text="formattedDate"></div>
                <button type="button" class="btn btn-ghost btn-sm" @click="nextDay()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
        </div>

        <!-- Time Pickers (hidden when all-day) -->
        <div x-show="!allDay" class="grid grid-cols-2 gap-4 mb-3">
            <!-- Start Time -->
            <div class="form-control">
                <label class="label"><span class="label-text font-medium">Start</span></label>
                <div class="flex items-center gap-1 justify-center">
                    <div class="flex flex-col items-center">
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustHour('start', 1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
                        </button>
                        <span class="text-2xl font-mono tabular-nums w-8 text-center" x-text="String(startHour12).padStart(2,' ')"></span>
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustHour('start', -1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                    </div>
                    <span class="text-2xl font-mono">:</span>
                    <div class="flex flex-col items-center">
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustMinute('start', 15)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
                        </button>
                        <span class="text-2xl font-mono tabular-nums w-8 text-center" x-text="String(startMinute).padStart(2,'0')"></span>
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustMinute('start', -15)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline ml-1 w-12" @click="toggleAmPm('start')" x-text="startAmPm"></button>
                </div>
            </div>

            <!-- End Time -->
            <div class="form-control">
                <label class="label"><span class="label-text font-medium">End</span></label>
                <div class="flex items-center gap-1 justify-center">
                    <div class="flex flex-col items-center">
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustHour('end', 1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
                        </button>
                        <span class="text-2xl font-mono tabular-nums w-8 text-center" x-text="String(endHour12).padStart(2,' ')"></span>
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustHour('end', -1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                    </div>
                    <span class="text-2xl font-mono">:</span>
                    <div class="flex flex-col items-center">
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustMinute('end', 15)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
                        </button>
                        <span class="text-2xl font-mono tabular-nums w-8 text-center" x-text="String(endMinute).padStart(2,'0')"></span>
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustMinute('end', -15)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline ml-1 w-12" @click="toggleAmPm('end')" x-text="endAmPm"></button>
                </div>
            </div>
        </div>

        <!-- Recurrence Selector -->
        <div class="form-control mb-3">
            <label class="label"><span class="label-text font-medium">Repeat</span></label>
            <select x-model="recurrence" class="select select-bordered w-full">
                <option value="">Does not repeat</option>
                <option value="FREQ=DAILY">Daily</option>
                <option value="FREQ=WEEKLY">Weekly</option>
                <option value="FREQ=WEEKLY;INTERVAL=2">Biweekly</option>
                <option value="FREQ=MONTHLY">Monthly</option>
                <option value="FREQ=YEARLY">Yearly</option>
            </select>
        </div>

        <!-- Family Member Selector -->
        {{if .Members}}
        <div class="form-control mb-3">
            <label class="label"><span class="label-text font-medium">Assigned to</span></label>
            <div class="flex flex-wrap gap-2">
                <button type="button"
                        class="avatar placeholder cursor-pointer transition-all"
                        :class="selectedMember === 0 ? 'ring ring-primary ring-offset-2' : 'opacity-50'"
                        @click="selectedMember = 0">
                    <div class="w-10 h-10 rounded-full bg-base-300 flex items-center justify-center text-sm">
                        --
                    </div>
                </button>
                {{range .Members}}
                <button type="button"
                        class="avatar placeholder cursor-pointer transition-all"
                        :class="selectedMember === {{.ID}} ? 'ring ring-primary ring-offset-2' : 'opacity-50'"
                        @click="selectedMember = {{.ID}}">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg"
                         style="background-color: {{.Color}}20; border: 2px solid {{.Color}}">
                        {{.AvatarEmoji}}
                    </div>
                </button>
                {{end}}
            </div>
        </div>
        {{end}}

        <!-- Location -->
        <div class="form-control mb-3">
            <label class="label"><span class="label-text font-medium">Location</span></label>
            <input type="text" name="location" x-model="location"
                   class="input input-bordered w-full"
                   placeholder="Add location">
        </div>

        <!-- Description -->
        <div class="form-control mb-4">
            <label class="label"><span class="label-text font-medium">Description</span></label>
            <textarea name="description" x-model="description"
                      class="textarea textarea-bordered w-full" rows="2"
                      placeholder="Add description"></textarea>
        </div>

        <!-- Hidden fields populated by Alpine -->
        <input type="hidden" name="date" :value="dateStr">
        <input type="hidden" name="start_hour" :value="get24Hour('start')">
        <input type="hidden" name="start_minute" :value="startMinute">
        <input type="hidden" name="end_hour" :value="get24Hour('end')">
        <input type="hidden" name="end_minute" :value="endMinute">
        <input type="hidden" name="all_day" :value="allDay ? '1' : '0'">
        <input type="hidden" name="family_member_id" :value="selectedMember || ''">
        <input type="hidden" name="recurrence_rule" :value="recurrence">

        <!-- Actions -->
        <div class="flex justify-end gap-2">
            <button type="button" class="btn btn-ghost"
                    onclick="document.getElementById('event-modal').close()">Cancel</button>
            <button type="submit" class="btn btn-primary"
                    onclick="document.getElementById('event-modal').close()">Create Event</button>
        </div>
    </form>
</div>

<script>
function eventForm() {
    return {
        title: '',
        allDay: false,
        dateYear: {{.DateYear}},
        dateMonth: {{.DateMonth}},
        dateDay: {{.DateDay}},
        startHour: {{.StartHour}},
        startMinute: {{.StartMinute}},
        startAmPm: {{.StartHour}} >= 12 ? 'PM' : 'AM',
        endHour: {{.EndHour}},
        endMinute: {{.EndMinute}},
        endAmPm: {{.EndHour}} >= 12 ? 'PM' : 'AM',
        selectedMember: 0,
        location: '',
        description: '',
        recurrence: '',

        get startHour12() {
            let h = this.startHour % 12;
            return h === 0 ? 12 : h;
        },
        get endHour12() {
            let h = this.endHour % 12;
            return h === 0 ? 12 : h;
        },
        get formattedDate() {
            let d = new Date(this.dateYear, this.dateMonth - 1, this.dateDay);
            return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        },
        get dateStr() {
            return `${this.dateYear}-${String(this.dateMonth).padStart(2,'0')}-${String(this.dateDay).padStart(2,'0')}`;
        },
        prevDay() {
            let d = new Date(this.dateYear, this.dateMonth - 1, this.dateDay);
            d.setDate(d.getDate() - 1);
            this.dateYear = d.getFullYear();
            this.dateMonth = d.getMonth() + 1;
            this.dateDay = d.getDate();
        },
        nextDay() {
            let d = new Date(this.dateYear, this.dateMonth - 1, this.dateDay);
            d.setDate(d.getDate() + 1);
            this.dateYear = d.getFullYear();
            this.dateMonth = d.getMonth() + 1;
            this.dateDay = d.getDate();
        },
        adjustHour(which, delta) {
            if (which === 'start') {
                this.startHour = (this.startHour + delta + 24) % 24;
                this.startAmPm = this.startHour >= 12 ? 'PM' : 'AM';
            } else {
                this.endHour = (this.endHour + delta + 24) % 24;
                this.endAmPm = this.endHour >= 12 ? 'PM' : 'AM';
            }
        },
        adjustMinute(which, delta) {
            if (which === 'start') {
                this.startMinute = (this.startMinute + delta + 60) % 60;
            } else {
                this.endMinute = (this.endMinute + delta + 60) % 60;
            }
        },
        toggleAmPm(which) {
            if (which === 'start') {
                this.startHour = (this.startHour + 12) % 24;
                this.startAmPm = this.startHour >= 12 ? 'PM' : 'AM';
            } else {
                this.endHour = (this.endHour + 12) % 24;
                this.endAmPm = this.endHour >= 12 ? 'PM' : 'AM';
            }
        },
        get24Hour(which) {
            return which === 'start' ? this.startHour : this.endHour;
        },
        prepareSubmit() {
            // Values are already in hidden fields via Alpine binding
        }
    };
}
</script>
{{end}}

{{define "event-edit-form"}}
<div x-data="eventEditForm()">
    <h3 class="text-xl font-bold mb-4">Edit Event</h3>

    <form hx-put="/partials/calendar/events/{{.ID}}"
          hx-target="#calendar-view-content"
          @submit="prepareSubmit()">

        <!-- Title -->
        <div class="form-control mb-3">
            <label class="label"><span class="label-text font-medium">Title</span></label>
            <input type="text" name="title" x-model="title"
                   class="input input-bordered input-lg w-full"
                   placeholder="Event title" required autofocus>
        </div>

        <!-- All Day Toggle -->
        <div class="form-control mb-3">
            <label class="label cursor-pointer justify-start gap-3">
                <input type="checkbox" x-model="allDay" class="toggle toggle-primary toggle-lg">
                <span class="label-text font-medium">All day</span>
            </label>
        </div>

        <!-- Date Picker -->
        <div class="form-control mb-3">
            <label class="label"><span class="label-text font-medium">Date</span></label>
            <div class="flex items-center gap-2">
                <button type="button" class="btn btn-ghost btn-sm" @click="prevDay()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <div class="flex-1 text-center text-lg font-medium" x-text="formattedDate"></div>
                <button type="button" class="btn btn-ghost btn-sm" @click="nextDay()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
        </div>

        <!-- Time Pickers (hidden when all-day) -->
        <div x-show="!allDay" class="grid grid-cols-2 gap-4 mb-3">
            <!-- Start Time -->
            <div class="form-control">
                <label class="label"><span class="label-text font-medium">Start</span></label>
                <div class="flex items-center gap-1 justify-center">
                    <div class="flex flex-col items-center">
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustHour('start', 1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
                        </button>
                        <span class="text-2xl font-mono tabular-nums w-8 text-center" x-text="String(startHour12).padStart(2,' ')"></span>
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustHour('start', -1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                    </div>
                    <span class="text-2xl font-mono">:</span>
                    <div class="flex flex-col items-center">
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustMinute('start', 15)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
                        </button>
                        <span class="text-2xl font-mono tabular-nums w-8 text-center" x-text="String(startMinute).padStart(2,'0')"></span>
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustMinute('start', -15)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline ml-1 w-12" @click="toggleAmPm('start')" x-text="startAmPm"></button>
                </div>
            </div>

            <!-- End Time -->
            <div class="form-control">
                <label class="label"><span class="label-text font-medium">End</span></label>
                <div class="flex items-center gap-1 justify-center">
                    <div class="flex flex-col items-center">
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustHour('end', 1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
                        </button>
                        <span class="text-2xl font-mono tabular-nums w-8 text-center" x-text="String(endHour12).padStart(2,' ')"></span>
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustHour('end', -1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                    </div>
                    <span class="text-2xl font-mono">:</span>
                    <div class="flex flex-col items-center">
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustMinute('end', 15)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
                        </button>
                        <span class="text-2xl font-mono tabular-nums w-8 text-center" x-text="String(endMinute).padStart(2,'0')"></span>
                        <button type="button" class="btn btn-ghost btn-xs" @click="adjustMinute('end', -15)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline ml-1 w-12" @click="toggleAmPm('end')" x-text="endAmPm"></button>
                </div>
            </div>
        </div>

        <!-- Recurrence Selector (only for non-recurring edits or "all" mode) -->
        {{if not .IsRecurring}}
        <div class="form-control mb-3">
            <label class="label"><span class="label-text font-medium">Repeat</span></label>
            <select x-model="recurrence" class="select select-bordered w-full">
                <option value="">Does not repeat</option>
                <option value="FREQ=DAILY">Daily</option>
                <option value="FREQ=WEEKLY">Weekly</option>
                <option value="FREQ=WEEKLY;INTERVAL=2">Biweekly</option>
                <option value="FREQ=MONTHLY">Monthly</option>
                <option value="FREQ=YEARLY">Yearly</option>
            </select>
        </div>
        {{end}}

        <!-- Family Member Selector -->
        {{if .Members}}
        <div class="form-control mb-3">
            <label class="label"><span class="label-text font-medium">Assigned to</span></label>
            <div class="flex flex-wrap gap-2">
                <button type="button"
                        class="avatar placeholder cursor-pointer transition-all"
                        :class="selectedMember === 0 ? 'ring ring-primary ring-offset-2' : 'opacity-50'"
                        @click="selectedMember = 0">
                    <div class="w-10 h-10 rounded-full bg-base-300 flex items-center justify-center text-sm">
                        --
                    </div>
                </button>
                {{range .Members}}
                <button type="button"
                        class="avatar placeholder cursor-pointer transition-all"
                        :class="selectedMember === {{.ID}} ? 'ring ring-primary ring-offset-2' : 'opacity-50'"
                        @click="selectedMember = {{.ID}}">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg"
                         style="background-color: {{.Color}}20; border: 2px solid {{.Color}}">
                        {{.AvatarEmoji}}
                    </div>
                </button>
                {{end}}
            </div>
        </div>
        {{end}}

        <!-- Location -->
        <div class="form-control mb-3">
            <label class="label"><span class="label-text font-medium">Location</span></label>
            <input type="text" name="location" x-model="location"
                   class="input input-bordered w-full"
                   placeholder="Add location">
        </div>

        <!-- Description -->
        <div class="form-control mb-4">
            <label class="label"><span class="label-text font-medium">Description</span></label>
            <textarea name="description" x-model="description"
                      class="textarea textarea-bordered w-full" rows="2"
                      placeholder="Add description"></textarea>
        </div>

        <!-- Hidden fields populated by Alpine -->
        <input type="hidden" name="date" :value="dateStr">
        <input type="hidden" name="start_hour" :value="get24Hour('start')">
        <input type="hidden" name="start_minute" :value="startMinute">
        <input type="hidden" name="end_hour" :value="get24Hour('end')">
        <input type="hidden" name="end_minute" :value="endMinute">
        <input type="hidden" name="all_day" :value="allDay ? '1' : '0'">
        <input type="hidden" name="family_member_id" :value="selectedMember || ''">
        <input type="hidden" name="recurrence_rule" :value="recurrence">
        {{if .Mode}}<input type="hidden" name="mode" value="{{.Mode}}">{{end}}
        {{if .ParentID}}<input type="hidden" name="parent_id" value="{{.ParentID}}">{{end}}
        {{if .OccurrenceDate}}<input type="hidden" name="occurrence_date" value="{{.OccurrenceDate}}">{{end}}

        <!-- Actions -->
        <div class="flex justify-end gap-2">
            <button type="button" class="btn btn-ghost"
                    onclick="document.getElementById('event-modal').close()">Cancel</button>
            <button type="submit" class="btn btn-primary"
                    onclick="document.getElementById('event-modal').close()">Save Changes</button>
        </div>
    </form>
</div>

<script>
function eventEditForm() {
    return {
        title: '{{.Title}}',
        allDay: {{if .AllDay}}true{{else}}false{{end}},
        dateYear: {{.DateYear}},
        dateMonth: {{.DateMonth}},
        dateDay: {{.DateDay}},
        startHour: {{.StartHour}},
        startMinute: {{.StartMinute}},
        startAmPm: {{.StartHour}} >= 12 ? 'PM' : 'AM',
        endHour: {{.EndHour}},
        endMinute: {{.EndMinute}},
        endAmPm: {{.EndHour}} >= 12 ? 'PM' : 'AM',
        selectedMember: {{if .FamilyMemberID}}{{.FamilyMemberID}}{{else}}0{{end}},
        location: '{{.Location}}',
        description: '{{.Description}}',
        recurrence: '{{.RecurrenceRule}}',

        get startHour12() {
            let h = this.startHour % 12;
            return h === 0 ? 12 : h;
        },
        get endHour12() {
            let h = this.endHour % 12;
            return h === 0 ? 12 : h;
        },
        get formattedDate() {
            let d = new Date(this.dateYear, this.dateMonth - 1, this.dateDay);
            return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        },
        get dateStr() {
            return `${this.dateYear}-${String(this.dateMonth).padStart(2,'0')}-${String(this.dateDay).padStart(2,'0')}`;
        },
        prevDay() {
            let d = new Date(this.dateYear, this.dateMonth - 1, this.dateDay);
            d.setDate(d.getDate() - 1);
            this.dateYear = d.getFullYear();
            this.dateMonth = d.getMonth() + 1;
            this.dateDay = d.getDate();
        },
        nextDay() {
            let d = new Date(this.dateYear, this.dateMonth - 1, this.dateDay);
            d.setDate(d.getDate() + 1);
            this.dateYear = d.getFullYear();
            this.dateMonth = d.getMonth() + 1;
            this.dateDay = d.getDate();
        },
        adjustHour(which, delta) {
            if (which === 'start') {
                this.startHour = (this.startHour + delta + 24) % 24;
                this.startAmPm = this.startHour >= 12 ? 'PM' : 'AM';
            } else {
                this.endHour = (this.endHour + delta + 24) % 24;
                this.endAmPm = this.endHour >= 12 ? 'PM' : 'AM';
            }
        },
        adjustMinute(which, delta) {
            if (which === 'start') {
                this.startMinute = (this.startMinute + delta + 60) % 60;
            } else {
                this.endMinute = (this.endMinute + delta + 60) % 60;
            }
        },
        toggleAmPm(which) {
            if (which === 'start') {
                this.startHour = (this.startHour + 12) % 24;
                this.startAmPm = this.startHour >= 12 ? 'PM' : 'AM';
            } else {
                this.endHour = (this.endHour + 12) % 24;
                this.endAmPm = this.endHour >= 12 ? 'PM' : 'AM';
            }
        },
        get24Hour(which) {
            return which === 'start' ? this.startHour : this.endHour;
        },
        prepareSubmit() {
            // Values are already in hidden fields via Alpine binding
        }
    };
}
</script>
{{end}}

{{define "calendar-event-detail"}}
<div>
    <h3 class="text-xl font-bold mb-4">
        {{if .IsRecurring}}<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>{{end}}
        {{.Title}}
    </h3>

    <div class="space-y-3">
        <!-- Time -->
        <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
                {{if .AllDay}}
                <div class="font-medium">All Day</div>
                <div class="text-sm text-base-content/60">{{.DateRange}}</div>
                {{else}}
                <div class="font-medium">{{.TimeRange}}</div>
                <div class="text-sm text-base-content/60">{{.DateLabel}}</div>
                {{end}}
            </div>
        </div>

        <!-- Recurrence Description -->
        {{if .RecurrenceDesc}}
        <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            <div class="font-medium">{{.RecurrenceDesc}}</div>
        </div>
        {{end}}

        <!-- Location -->
        {{if .Location}}
        <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <div class="font-medium">{{.Location}}</div>
        </div>
        {{end}}

        <!-- Family Member -->
        {{if .MemberName}}
        <div class="flex items-center gap-3">
            <div class="w-5 h-5 rounded-full flex items-center justify-center text-xs"
                 style="background-color: {{.MemberColor}}20; border: 2px solid {{.MemberColor}}">
                {{.MemberEmoji}}
            </div>
            <div class="font-medium">{{.MemberName}}</div>
        </div>
        {{end}}

        <!-- Description -->
        {{if .Description}}
        <div class="mt-2 p-3 bg-base-200 rounded-lg text-sm">{{.Description}}</div>
        {{end}}
    </div>

    <!-- Actions -->
    <div class="flex justify-end gap-2 mt-6">
        {{if .IsRecurring}}
        <button class="btn btn-error btn-outline"
                hx-get="/partials/calendar/events/{{.ID}}/recurrence-delete?parent_id={{.ParentID}}&occurrence_date={{.OccurrenceDate}}"
                hx-target="#event-modal-body"
                hx-swap="innerHTML">Delete</button>
        <button class="btn btn-primary"
                hx-get="/partials/calendar/events/{{.ID}}/recurrence-edit?parent_id={{.ParentID}}&occurrence_date={{.OccurrenceDate}}"
                hx-target="#event-modal-body"
                hx-swap="innerHTML">Edit</button>
        {{else}}
        <button class="btn btn-error btn-outline"
                hx-delete="/partials/calendar/events/{{.ID}}"
                hx-target="#calendar-view-content"
                hx-confirm="Delete this event?"
                onclick="document.getElementById('event-modal').close()">Delete</button>
        <button class="btn btn-primary"
                hx-get="/partials/calendar/events/{{.ID}}/edit"
                hx-target="#event-modal-body"
                hx-swap="innerHTML">Edit</button>
        {{end}}
    </div>
</div>
{{end}}

{{define "recurrence-edit-choice"}}
<div>
    <h3 class="text-xl font-bold mb-4">Edit recurring event</h3>
    <p class="text-base-content/60 mb-6">How would you like to edit this event?</p>

    <div class="space-y-3">
        <button class="btn btn-block btn-outline"
                hx-get="/partials/calendar/events/{{.ID}}/edit?mode=single&parent_id={{.ParentID}}&occurrence_date={{.OccurrenceDate}}"
                hx-target="#event-modal-body"
                hx-swap="innerHTML">
            This event only
        </button>
        <button class="btn btn-block btn-outline"
                hx-get="/partials/calendar/events/{{.ParentID}}/edit?mode=all&parent_id={{.ParentID}}&occurrence_date={{.OccurrenceDate}}"
                hx-target="#event-modal-body"
                hx-swap="innerHTML">
            All events in the series
        </button>
    </div>

    <div class="flex justify-end mt-6">
        <button class="btn btn-ghost"
                onclick="document.getElementById('event-modal').close()">Cancel</button>
    </div>
</div>
{{end}}

{{define "recurrence-delete-choice"}}
<div>
    <h3 class="text-xl font-bold mb-4">Delete recurring event</h3>
    <p class="text-base-content/60 mb-6">How would you like to delete this event?</p>

    <div class="space-y-3">
        <button class="btn btn-block btn-error btn-outline"
                hx-delete="/partials/calendar/events/{{.ID}}?mode=single&parent_id={{.ParentID}}&occurrence_date={{.OccurrenceDate}}"
                hx-target="#calendar-view-content"
                onclick="document.getElementById('event-modal').close()">
            This event only
        </button>
        <button class="btn btn-block btn-error btn-outline"
                hx-delete="/partials/calendar/events/{{.ParentID}}?mode=all&parent_id={{.ParentID}}"
                hx-target="#calendar-view-content"
                onclick="document.getElementById('event-modal').close()">
            All events in the series
        </button>
    </div>

    <div class="flex justify-end mt-6">
        <button class="btn btn-ghost"
                onclick="document.getElementById('event-modal').close()">Cancel</button>
    </div>
</div>
{{end}}
