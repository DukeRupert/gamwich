{{define "family_members.html"}}
<!DOCTYPE html>
<html lang="en" data-theme="garden">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.23/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
    <style>
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator { display: inline; }
        .htmx-request.htmx-indicator { display: inline; }
    </style>
</head>
<body class="min-h-screen bg-base-200">
    <div class="navbar bg-base-100 shadow-md">
        <div class="flex-1">
            <a href="/" class="btn btn-ghost text-xl">ğŸ  Gamwich</a>
        </div>
        <div class="flex-none">
            <ul class="menu menu-horizontal px-1">
                <li><a href="/settings/family" class="btn btn-ghost font-bold">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family</a></li>
            </ul>
        </div>
    </div>

    <main class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-3xl font-bold mb-6">Family Members</h1>

        <!-- Add Member Form -->
        <div class="card bg-base-100 shadow-md mb-6">
            <div class="card-body">
                <h2 class="card-title">Add Family Member</h2>
                <form hx-post="/partials/family-members"
                      hx-target="#member-list"
                      hx-swap="innerHTML"
                      hx-on::after-request="if(event.detail.successful) this.reset()"
                      class="flex flex-wrap gap-4 items-end">
                    <div class="form-control flex-1 min-w-[200px]">
                        <label class="label"><span class="label-text">Name</span></label>
                        <input type="text" name="name" placeholder="Enter name" class="input input-bordered input-lg" required />
                    </div>
                    <div class="form-control w-24">
                        <label class="label"><span class="label-text">Color</span></label>
                        <input type="color" name="color" value="#3B82F6" class="input input-bordered input-lg h-12 w-full p-1 cursor-pointer" />
                    </div>
                    <div class="form-control w-32">
                        <label class="label"><span class="label-text">Emoji</span></label>
                        <select name="avatar_emoji" class="select select-bordered select-lg">
                            <option value="ğŸ˜€">ğŸ˜€</option>
                            <option value="ğŸ˜">ğŸ˜</option>
                            <option value="ğŸ¥°">ğŸ¥°</option>
                            <option value="ğŸ¤“">ğŸ¤“</option>
                            <option value="ğŸ‘¨">ğŸ‘¨</option>
                            <option value="ğŸ‘©">ğŸ‘©</option>
                            <option value="ğŸ‘¦">ğŸ‘¦</option>
                            <option value="ğŸ‘§">ğŸ‘§</option>
                            <option value="ğŸ§‘">ğŸ§‘</option>
                            <option value="ğŸ‘¶">ğŸ‘¶</option>
                            <option value="ğŸ¶">ğŸ¶</option>
                            <option value="ğŸ±">ğŸ±</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg">Add Member</button>
                </form>
            </div>
        </div>

        <!-- Member List -->
        <div id="member-list">
            {{template "member-list" .}}
        </div>
    </main>

    <!-- Global toast container -->
    <div id="toast-container" class="toast toast-top toast-end z-50"></div>
</body>
</html>
{{end}}

{{define "member-list"}}
{{if .Members}}
<div class="flex flex-col gap-4">
    {{range .Members}}
    <div id="member-{{.ID}}" class="card bg-base-100 shadow-md">
        <div class="card-body flex-row items-center gap-4">
            <div class="avatar placeholder">
                <div class="w-16 h-16 rounded-full flex items-center justify-center text-3xl" style="background-color: {{.Color}}20; border: 3px solid {{.Color}}">
                    {{.AvatarEmoji}}
                </div>
            </div>
            <div class="flex-1">
                <h3 class="text-xl font-bold">{{.Name}}</h3>
                <div class="flex gap-2 mt-1">
                    <span class="badge" style="background-color: {{.Color}}; color: white;">{{.Color}}</span>
                    {{if .HasPIN}}<span class="badge badge-success">PIN Set</span>{{else}}<span class="badge badge-ghost">No PIN</span>{{end}}
                </div>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-sm btn-ghost"
                        hx-get="/partials/family-members/{{.ID}}/edit"
                        hx-target="#member-{{.ID}}"
                        hx-swap="outerHTML">
                    âœï¸ Edit
                </button>
                <button class="btn btn-sm btn-ghost"
                        hx-get="/partials/family-members/{{.ID}}/pin"
                        hx-target="#member-{{.ID}}"
                        hx-swap="outerHTML">
                    ğŸ”‘ PIN
                </button>
                <button class="btn btn-sm btn-error btn-outline"
                        hx-delete="/partials/family-members/{{.ID}}"
                        hx-target="#member-list"
                        hx-swap="innerHTML"
                        hx-confirm="Delete {{.Name}}? This cannot be undone.">
                    ğŸ—‘ï¸
                </button>
            </div>
        </div>
    </div>
    {{end}}
</div>
{{else}}
<div class="text-center py-12">
    <p class="text-xl text-base-content/60">No family members yet. Add your first one above!</p>
</div>
{{end}}
{{end}}

{{define "member-edit-form"}}
<div id="member-{{.ID}}" class="card bg-base-100 shadow-md border-2 border-primary">
    <div class="card-body">
        <h3 class="card-title">Edit {{.Name}}</h3>
        <form hx-put="/partials/family-members/{{.ID}}"
              hx-target="#member-list"
              hx-swap="innerHTML"
              class="flex flex-wrap gap-4 items-end">
            <div class="form-control flex-1 min-w-[200px]">
                <label class="label"><span class="label-text">Name</span></label>
                <input type="text" name="name" value="{{.Name}}" class="input input-bordered input-lg" required />
            </div>
            <div class="form-control w-24">
                <label class="label"><span class="label-text">Color</span></label>
                <input type="color" name="color" value="{{.Color}}" class="input input-bordered input-lg h-12 w-full p-1 cursor-pointer" />
            </div>
            <div class="form-control w-32">
                <label class="label"><span class="label-text">Emoji</span></label>
                <select name="avatar_emoji" class="select select-bordered select-lg">
                    <option value="ğŸ˜€" {{if eq .AvatarEmoji "ğŸ˜€"}}selected{{end}}>ğŸ˜€</option>
                    <option value="ğŸ˜" {{if eq .AvatarEmoji "ğŸ˜"}}selected{{end}}>ğŸ˜</option>
                    <option value="ğŸ¥°" {{if eq .AvatarEmoji "ğŸ¥°"}}selected{{end}}>ğŸ¥°</option>
                    <option value="ğŸ¤“" {{if eq .AvatarEmoji "ğŸ¤“"}}selected{{end}}>ğŸ¤“</option>
                    <option value="ğŸ‘¨" {{if eq .AvatarEmoji "ğŸ‘¨"}}selected{{end}}>ğŸ‘¨</option>
                    <option value="ğŸ‘©" {{if eq .AvatarEmoji "ğŸ‘©"}}selected{{end}}>ğŸ‘©</option>
                    <option value="ğŸ‘¦" {{if eq .AvatarEmoji "ğŸ‘¦"}}selected{{end}}>ğŸ‘¦</option>
                    <option value="ğŸ‘§" {{if eq .AvatarEmoji "ğŸ‘§"}}selected{{end}}>ğŸ‘§</option>
                    <option value="ğŸ§‘" {{if eq .AvatarEmoji "ğŸ§‘"}}selected{{end}}>ğŸ§‘</option>
                    <option value="ğŸ‘¶" {{if eq .AvatarEmoji "ğŸ‘¶"}}selected{{end}}>ğŸ‘¶</option>
                    <option value="ğŸ¶" {{if eq .AvatarEmoji "ğŸ¶"}}selected{{end}}>ğŸ¶</option>
                    <option value="ğŸ±" {{if eq .AvatarEmoji "ğŸ±"}}selected{{end}}>ğŸ±</option>
                </select>
            </div>
            <div class="flex gap-2">
                <button type="submit" class="btn btn-primary btn-lg">Save</button>
                <button type="button" class="btn btn-ghost btn-lg"
                        hx-get="/partials/family-members"
                        hx-target="#member-list"
                        hx-swap="innerHTML">Cancel</button>
            </div>
        </form>
    </div>
</div>
{{end}}

{{define "pin-setup"}}
<div id="member-{{.ID}}" class="card bg-base-100 shadow-md border-2 border-secondary" x-data="{ pin: '' }">
    <div class="card-body">
        <h3 class="card-title">Set PIN for {{.Name}}</h3>

        <p class="text-sm text-base-content/60 mb-4">Enter a 4-digit PIN for quick identification on the touchscreen.</p>

        <form hx-post="/partials/family-members/{{.ID}}/pin"
              hx-target="#member-list"
              hx-swap="innerHTML"
              class="flex flex-col items-center gap-4">

            <input type="hidden" name="pin" :value="pin" />

            <!-- PIN display -->
            <div class="flex gap-3 mb-2">
                <template x-for="i in 4" :key="i">
                    <div class="w-14 h-14 border-2 rounded-lg flex items-center justify-center text-2xl font-bold"
                         :class="pin.length >= i ? 'border-primary bg-primary/10' : 'border-base-300'">
                        <span x-show="pin.length >= i">&#9679;</span>
                    </div>
                </template>
            </div>

            <!-- Number pad -->
            <div class="grid grid-cols-3 gap-2 max-w-xs">
                <template x-for="n in [1,2,3,4,5,6,7,8,9]" :key="n">
                    <button type="button"
                            class="btn btn-lg btn-outline w-16 h-16 text-xl"
                            @click="if(pin.length < 4) pin += n.toString()"
                            x-text="n"></button>
                </template>
                <div></div>
                <button type="button"
                        class="btn btn-lg btn-outline w-16 h-16 text-xl"
                        @click="if(pin.length < 4) pin += '0'">0</button>
                <button type="button"
                        class="btn btn-lg btn-ghost w-16 h-16 text-xl"
                        @click="pin = pin.slice(0, -1)">&#9003;</button>
            </div>

            <div class="flex gap-2 mt-4">
                <button type="submit"
                        class="btn btn-primary btn-lg"
                        :disabled="pin.length !== 4">Set PIN</button>
                <button type="button"
                        class="btn btn-ghost btn-lg"
                        hx-get="/partials/family-members"
                        hx-target="#member-list"
                        hx-swap="innerHTML">Cancel</button>
            </div>
        </form>
    </div>
</div>
{{end}}

{{define "pin-manage"}}
<div id="member-{{.ID}}" class="card bg-base-100 shadow-md border-2 border-secondary">
    <div class="card-body items-center text-center">
        <h3 class="card-title">PIN for {{.Name}}</h3>
        <p class="text-sm text-base-content/60 mb-4">PIN is currently set. What would you like to do?</p>
        <div class="flex gap-3">
            <button class="btn btn-primary btn-lg"
                    hx-get="/partials/family-members/{{.ID}}/pin/gate?next=change"
                    hx-target="#member-{{.ID}}"
                    hx-swap="outerHTML">Change PIN</button>
            <button class="btn btn-warning btn-lg"
                    hx-get="/partials/family-members/{{.ID}}/pin/gate?next=clear"
                    hx-target="#member-{{.ID}}"
                    hx-swap="outerHTML">Remove PIN</button>
            <button class="btn btn-ghost btn-lg"
                    hx-get="/partials/family-members"
                    hx-target="#member-list"
                    hx-swap="innerHTML">Cancel</button>
        </div>
    </div>
</div>
{{end}}

{{define "toast-success"}}
<div id="toast-container" hx-swap-oob="afterbegin:#toast-container">
    <div class="alert alert-success shadow-lg" x-data x-init="setTimeout(() => $el.remove(), 3000)">
        <span>{{.Message}}</span>
    </div>
</div>
{{end}}

{{define "toast-error"}}
<div id="toast-container" hx-swap-oob="afterbegin:#toast-container">
    <div class="alert alert-error shadow-lg" x-data x-init="setTimeout(() => $el.remove(), 3000)">
        <span>{{.Message}}</span>
    </div>
</div>
{{end}}

{{define "pin-verify"}}
<div id="member-{{.ID}}" class="card bg-base-100 shadow-md border-2 border-warning" x-data="{ pin: '' }">
    <div class="card-body">
        <h3 class="card-title">Enter current PIN for {{.Name}}</h3>
        <p class="text-sm text-base-content/60 mb-4">Verify your identity before changing PIN settings.</p>

        <form hx-post="/partials/family-members/{{.ID}}/pin/verify"
              hx-target="#member-{{.ID}}"
              hx-swap="outerHTML"
              class="flex flex-col items-center gap-4">

            <input type="hidden" name="pin" :value="pin" />
            <input type="hidden" name="next_action" value="{{.NextAction}}" />

            <!-- PIN display -->
            <div class="flex gap-3 mb-2">
                <template x-for="i in 4" :key="i">
                    <div class="w-14 h-14 border-2 rounded-lg flex items-center justify-center text-2xl font-bold"
                         :class="pin.length >= i ? 'border-warning bg-warning/10' : 'border-base-300'">
                        <span x-show="pin.length >= i">&#9679;</span>
                    </div>
                </template>
            </div>

            <!-- Number pad -->
            <div class="grid grid-cols-3 gap-2 max-w-xs">
                <template x-for="n in [1,2,3,4,5,6,7,8,9]" :key="n">
                    <button type="button"
                            class="btn btn-lg btn-outline w-16 h-16 text-xl"
                            @click="if(pin.length < 4) pin += n.toString()"
                            x-text="n"></button>
                </template>
                <div></div>
                <button type="button"
                        class="btn btn-lg btn-outline w-16 h-16 text-xl"
                        @click="if(pin.length < 4) pin += '0'">0</button>
                <button type="button"
                        class="btn btn-lg btn-ghost w-16 h-16 text-xl"
                        @click="pin = pin.slice(0, -1)">&#9003;</button>
            </div>

            <div class="flex gap-2 mt-4">
                <button type="submit"
                        class="btn btn-warning btn-lg"
                        :disabled="pin.length !== 4">Verify</button>
                <button type="button"
                        class="btn btn-ghost btn-lg"
                        hx-get="/partials/family-members"
                        hx-target="#member-list"
                        hx-swap="innerHTML">Cancel</button>
            </div>
        </form>
    </div>
</div>
{{end}}
